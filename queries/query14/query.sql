CREATE TABLE t0 ( c0 UNSIGNED BIG INT PRIMARY KEY , c1 CLOB , c2 , c3 , c4 , c5 INT ) ;
CREATE TABLE t3 ( c0 DOUBLE PRECISION PRIMARY KEY , c1 DATE , c2 , c3 BIGINT , c4 CLOB , c5 , c6 , c7 NCHAR ) ;
CREATE TABLE t5 ( c0 CHARACTER PRIMARY KEY , c1 MEDIUMINT , c2 CHARACTER ) ;
INSERT INTO t5 VALUES ('-u!.j!p2P rZ' , -7608565 , 'etWPioGcJ-r9'), ('aFGxdW5PRFhKFE' , -2444631 , 'H4 , C0XvPP8W8Yq'), ('aZbvf3I7q , AKk' , -1947983 , '?l , nL9H'), ('N1L0J1RZsIbuJ0!g' , 923750 , 'zo2oR'), ('_JB5-Z!' , -2877915 , 'dD0J0N-77?0Uo1e , '), ('Q_YOxU o' , 4636258 , 'Z_SRJld5gVFP'), ('mNlEgKF2!' , -584367 , 'wx_TvWXV'), ('CuA1emC-R' , 1509128 , 'MDhbR RClrvKHOzN'), ('mFCgpHaC-_' , 3353807 , 'usA8w_mSpY?_ TL'), ('v , v77liG' , 4349642 , 'DXPmTZ.P2!Kx'), ('crx8flX , g02DPmA' , -1990450 , '8GrbC9U_7Xhk'), ('G-.Xe7' , 684380 , 'UrnRAA2g3VUV3 '), ('Q9AVRo28eIMSq' , 3937253 , '9l4xWb.nvV?BgZ4c'), ('9pYLxycVQp6B' , 2005450 , ' , ?!lycuysWJ'), ('tHF9J0B9' , -5586608 , 'z.jePZ7T-'), ('FawzS_iRS82M' , -5313409 , 'JqWLoScb'), ('20EMpwWKwVfC8' , 7771574 , 'e65r1Y'), ('Tz_CJnPo7 , BwVipSd' , 2940263 , 'QtbpQ?E1w4Z.HCxWFM!'), ('kya9nkIDJqikr9' , 6088621 , 'NuK?YToc7mCYQ6FBZo'), ('j_jxija' , -2685025 , ' QedKsQ_yLuMR.Y'), ('05ytv3iYVR4iSWbaJ3da' , -6561348 , 'sJG9T0M'), ('z2p_pAo_DI8FfutF0' , -1470225 , 'ZhJicQ'), ('de GCJAmNWk1do7XAN?J' , 6645446 , 'Z_WaSBSPcXmzWvDYb!k'), ('LSYOD5bxRq3.' , 2778922 , 'vbB6VDNCblDJ5D!fLvf'), ('KUJR-z6b72tA , 5j' , 3359107 , '?1mic'), ('bT-Nxqsh' , -1028521 , 'g2SsLta , KC fnlM!EITo'), ('?m9n_o' , -5416584 , 'o2QDi5yH!b'), ('Dr2T2W2' , -8072188 , 'Vut!Zi4?'), ('tfU3oMigZU1ZvvCdAmU6' , 5315105 , 't-Vazhk'), ('xXF-q2Re' , -8369543 , 'fJ8_HW7Lf'), ('tD5dr NbhE' , 83100 , '2!mmVhgBRvs'), ('5QC6bWkkO?i' , 1579836 , 'LH-Jz G'), ('!A1rZ5g!-HGDXSvct' , 930168 , 'yIioLV'), ('mKUBXhc6m3D- cn' , -901863 , 'pnscE'), ('Z43 , OzKdAwr' , 8124048 , '-p0kCOmOi4iLdqHsqKS'), ('dthFdZTo' , 5302984 , 'M!x_f1QuMqSo'), ('3E75kVioit , ' , 3912383 , 'UiE5FLuqN6'), ('V?KxKy2FWQJ7deO!sb?f' , 5112056 , 'LRsV3glE4Y?'), ('MV6H7EW , 4-Q' , 500598 , 'iKbYn4mYe.mz6H!OfRi'), ('wZfDq2b1t8' , -5392615 , '?XZp.GNkqxYR4'), ('gcam8ECh9GLNzzO?' , 7774759 , 'MU3s2fK'), ('dG8_2O__cSqB.3' , -5546456 , 'z2 , o9Fp.q6fRfJ'), ('7tiG-YFjdHP9D9' , -7571907 , 'Zi9ZSyH5cf'), ('mgpktsi4IpsLnYx.E' , -4702394 , 'b?S1ByB');
INSERT INTO t3 VALUES (-8.3900000000000005684 , '2011-05-23' , X'7953593a0745' , 693447343 , 'O9PGx' , 'CGrrK4o' , 'jndFDibl7Hpj9tR8' , 'TDyve4sk'), (86.540000000000006251 , '2021-08-18' , X'0c3d16' , -1059510621 , 'MhHsDWgEBItnkbawxBMY' , '7nze8?aayb1TE3.Es' , '3UGvrVCZ' , '.LP300i_b7xlEk!6-WlF');
WITH t1_stats AS (SELECT c1 , COUNT ( * ) as count , AVG ( c0 ) as avg_pk FROM t5 GROUP BY c1), t2_derived AS (SELECT c0 , c3 , CASE WHEN c3 IS NULL THEN 'Unknown' WHEN c3 < 50 THEN 'Low' ELSE 'High' END as category FROM t3)
SELECT main.* , ( SELECT AVG ( count ) FROM t1_stats ) as overall_avg , ( SELECT COUNT ( * ) FROM ( SELECT t3.c0 , LAG ( t3.c4 ) OVER ( ORDER BY t3.c0 ) as prev_val , LEAD ( t3.c4 ) OVER ( ORDER BY t3.c0 ) as next_val FROM t0 t3 WHERE t3.c0 IN ( SELECT td.c0 FROM t2_derived td WHERE td.category = main.category UNION SELECT ts.avg_pk FROM t1_stats ts WHERE ts.c1 = main.c1 ) ) complex_window WHERE complex_window.prev_val IS NOT NULL OR complex_window.next_val IS NOT NULL ) as window_matches FROM ( SELECT ts.c1 , td.category , ts.count , ts.avg_pk , DENSE_RANK ( ) OVER ( PARTITION BY td.category ORDER BY ts.count DESC ) as rank_in_category FROM t1_stats ts CROSS JOIN ( SELECT category FROM t2_derived ) td ) main WHERE main.rank_in_category <= 2 ORDER BY main.category , main.rank_in_category ;
